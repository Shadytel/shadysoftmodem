#include <string.h>

#include "resample.h"

#define PHASES 5
#define PHASE_INCREMENT 6
#define SAMPLES_PER_PHASE 175

int32_t taps[PHASES][SAMPLES_PER_PHASE] = 
    {
       {     0,      0,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      1,     -1,      1,
             0,     -1,      3,     -4,      4,     -1,     -3,      8,
           -10,      8,     -1,     -8,     17,    -20,     13,      1,
           -20,     34,    -35,     20,      9,    -41,     62,    -58,
            25,     26,    -77,    103,    -87,     26,     59,   -135,
           163,   -121,     15,    118,   -222,    244,   -158,    -15,
           214,   -350,    350,   -190,    -82,    366,   -531,    484,
          -208,   -209,    603,   -793,    655,   -194,   -438,    990,
         -1195,    892,   -115,   -884,   1704,  -1927,   1299,    137,
         -1986,   3558,  -4028,   2605,   1454,  -9670,  34651,  43732,
         -4966,  -2674,   5012,  -4666,   2873,   -657,  -1164,   2098,
         -2041,   1237,   -130,   -815,   1281,  -1177,    641,     54,
          -618,    857,   -728,    338,    125,   -471,    584,   -454,
           167,    142,   -351,    393,   -276,     69,    133,   -253,
           257,   -160,     17,    110,   -174,    161,    -87,     -7,
            83,   -114,     95,    -43,    -15,     58,    -70,     53,
           -19,    -15,     37,    -40,     27,     -6,    -12,     22,
           -21,     12,     -1,     -7,     11,    -10,      5,      0,
            -4,      5,     -4,      1,      0,     -2,      2,     -1,
             0,      0,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      0,      0},
       {     0,      0,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      1,     -1,      1,
             0,     -2,      3,     -3,      1,      1,     -6,      8,
            -8,      2,      5,    -14,     18,    -14,      2,     14,
           -28,     33,    -22,     -1,     30,    -53,     55,    -32,
           -11,     60,    -91,     86,    -40,    -35,    110,   -149,
           127,    -41,    -79,    187,   -229,    174,    -28,   -156,
           303,   -337,    224,     10,   -281,    471,   -479,    271,
            96,   -482,    717,   -666,    303,    261,   -810,   1092,
          -928,    305,    585,  -1398,   1747,  -1362,    233,   1334,
         -2766,   3362,  -2510,   -142,   4661, -11241,  23810,  49767,
          2716,  -6853,   6433,  -4179,   1408,    928,  -2254,   2417,
         -1653,    441,    689,  -1342,   1368,   -868,    120,    551,
          -904,    854,   -482,    -19,    439,   -627,    544,   -262,
           -79,    340,   -431,    341,   -132,    -96,    254,   -289,
           206,    -57,    -91,    180,   -186,    118,    -16,    -75,
           122,   -114,     63,      2,    -55,     77,    -66,     31,
             9,    -37,     46,    -35,     13,      9,    -23,     25,
           -17,      4,      7,    -13,     12,     -7,      1,      4,
            -6,      5,     -3,      0,      2,     -2,      2,      0,
             0,      0,     -1,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      0,      0},
       {     0,      0,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,     -1,      1,     -1,      0,
             1,     -3,      3,     -2,      0,      4,     -7,      7,
            -3,     -3,     10,    -15,     14,     -5,     -8,     22,
           -29,     23,     -4,    -21,     44,    -51,     36,      0,
           -44,     79,    -83,     50,     14,    -85,    132,   -126,
            61,     45,   -152,    209,   -181,     64,    103,   -254,
           316,   -244,     49,    203,   -407,    461,   -314,      0,
           368,   -632,    655,   -384,   -108,    640,   -977,    929,
          -448,   -332,   1120,  -1559,   1373,   -500,   -834,   2151,
         -2847,   2392,   -534,  -2576,   6380, -10044,  12689,  51882,
         12689, -10044,   6380,  -2576,   -534,   2392,  -2847,   2151,
          -834,   -500,   1373,  -1559,   1120,   -332,   -448,    929,
          -977,    640,   -108,   -384,    655,   -632,    368,      0,
          -314,    461,   -407,    203,     49,   -244,    316,   -254,
           103,     64,   -181,    209,   -152,     45,     61,   -126,
           132,    -85,     14,     50,    -83,     79,    -44,      0,
            36,    -51,     44,    -21,     -4,     23,    -29,     22,
            -8,     -5,     14,    -15,     10,     -3,     -3,      7,
            -7,      4,      0,     -2,      3,     -3,      1,      0,
            -1,      1,     -1,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      0,      0},
       {     0,      0,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,     -1,      0,      0,      0,
             2,     -2,      2,      0,     -3,      5,     -6,      4,
             1,     -7,     12,    -13,      7,      4,    -17,     25,
           -23,      9,     13,    -35,     46,    -37,      9,     31,
           -66,     77,    -55,      2,     63,   -114,    122,    -75,
           -16,    118,   -186,    180,    -91,    -57,    206,   -289,
           254,    -96,   -132,    341,   -431,    340,    -79,   -262,
           544,   -627,    439,    -19,   -482,    854,   -904,    551,
           120,   -868,   1368,  -1342,    689,    441,  -1653,   2417,
         -2254,    928,   1408,  -4179,   6433,  -6853,   2716,  49767,
         23810, -11241,   4661,   -142,  -2510,   3362,  -2766,   1334,
           233,  -1362,   1747,  -1398,    585,    305,   -928,   1092,
          -810,    261,    303,   -666,    717,   -482,     96,    271,
          -479,    471,   -281,     10,    224,   -337,    303,   -156,
           -28,    174,   -229,    187,    -79,    -41,    127,   -149,
           110,    -35,    -40,     86,    -91,     60,    -11,    -32,
            55,    -53,     30,     -1,    -22,     33,    -28,     14,
             2,    -14,     18,    -14,      5,      2,     -8,      8,
            -6,      1,      1,     -3,      3,     -2,      0,      1,
            -1,      1,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      0,      0},
       {     0,      0,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      0,      0,     -1,
             2,     -2,      0,      1,     -4,      5,     -4,      0,
             5,    -10,     11,     -7,     -1,     12,    -21,     22,
           -12,     -6,     27,    -40,     37,    -15,    -19,     53,
           -70,     58,    -15,    -43,     95,   -114,     83,     -7,
           -87,    161,   -174,    110,     17,   -160,    257,   -253,
           133,     69,   -276,    393,   -351,    142,    167,   -454,
           584,   -471,    125,    338,   -728,    857,   -618,     54,
           641,  -1177,   1281,   -815,   -130,   1237,  -2041,   2098,
         -1164,   -657,   2873,  -4666,   5012,  -2674,  -4966,  43732,
         34651,  -9670,   1454,   2605,  -4028,   3558,  -1986,    137,
          1299,  -1927,   1704,   -884,   -115,    892,  -1195,    990,
          -438,   -194,    655,   -793,    603,   -209,   -208,    484,
          -531,    366,    -82,   -190,    350,   -350,    214,    -15,
          -158,    244,   -222,    118,     15,   -121,    163,   -135,
            59,     26,    -87,    103,    -77,     26,     25,    -58,
            62,    -41,      9,     20,    -35,     34,    -20,      1,
            13,    -20,     17,     -8,     -1,      8,    -10,      8,
            -3,     -1,      4,     -4,      3,     -1,      0,      1,
            -1,      1,      0,      0,      0,      0,      0,      0,
             0,      0,      0,      0,      0,      0,      0}};

typedef struct {
    int16_t history[SAMPLES_PER_PHASE];
    size_t historyIdx;
    size_t phase;
} ResamplerState;

ResamplerState state;

void resamp_8khz_9k6hz_init() {
    memset(state.history, 0, sizeof(state.history));
    state.historyIdx = 0;
    state.phase = 0;
}

size_t resamp_8khz_9k6hz(int16_t * in, size_t inCount, int16_t * out, size_t maxOut) {
    while (inCount--) {
        state.history[state.historyIdx++] = *in++;
        if (state.historyIdx >= SAMPLES_PER_PHASE) {
            state.historyIdx = 0;
        }

        while (state.phase < PHASES && maxOut--) {
            int32_t acc = 0;
            size_t cti = state.historyIdx;
            for (size_t tapIndex = 0; tapIndex < SAMPLES_PER_PHASE; tapIndex++) {
                acc += state.history[cti] * taps[state.phase][tapIndex];
                if (++cti >= SAMPLES_PER_PHASE) {
                    cti = 0;
                }
            }
            *out++ = acc >> 16;
            state.phase += PHASE_INCREMENT;
        }

        state.phase -= PHASES;
    }

    return maxOut;
}
